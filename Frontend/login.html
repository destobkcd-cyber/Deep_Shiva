<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Agriculture ‚Äì Sign in or Create account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="login.css" />
</head>
<body class="app-body">
  <!-- Background texture -->
  <div class="grain-overlay"></div>
  <div class="bg-orbit-saffron"></div>
  <div class="bg-orbit-green"></div>

  <!-- Top brand bar -->
  <header class="header">
    <div class="header-main">
      <div class="header-logo">
        <span class="logo-mark">
          <span class="logo-leaf"></span>
        </span>
        <div>
          <div class="logo-title">Smart Agriculture</div>
          <div class="logo-subtitle">
            Weather, mandi, tasks and AI ‚Äì in one secure place.
          </div>
        </div>
      </div>
      <div class="header-meta">
        <span class="chip chip-soft">Secure access</span>
      </div>
    </div>
  </header>

  <!-- Auth shell -->
  <main class="auth-shell single-col">
    <section class="auth-card glass" aria-label="Authentication">
      <!-- Brand / intro -->
      <div class="auth-brand centered">
        <span class="logo-mark small">
          <span class="logo-leaf"></span>
        </span>
        <div>
          <h1 class="auth-title main">Welcome to your farm HQ</h1>
          <p class="auth-subtitle main">
            Log in or create an account to manage your fields like a pro.
          </p>
        </div>
      </div>

      <!-- Tabs: Login / Sign up -->
      <div class="auth-tabs" role="tablist">
        <button
          class="auth-tab active"
          id="tab-login"
          type="button"
          role="tab"
          aria-selected="true"
          aria-controls="panel-login"
        >
          Login
        </button>
        <button
          class="auth-tab"
          id="tab-signup"
          type="button"
          role="tab"
          aria-selected="false"
          aria-controls="panel-signup"
        >
          Create account
        </button>
      </div>

      <!-- Social login buttons (UI only for now) -->
      <div class="social-column">
        <button type="button" class="btn-social google" id="google-login">
          <span class="icon-circle">G</span>
          <span>Continue with Google</span>
        </button>
        <button type="button" class="btn-social apple" id="apple-login">
          <span class="icon-circle">Ô£ø</span>
          <span>Continue with Apple</span>
        </button>
      </div>

      <div class="divider compact">
        <span></span>
        <p>or use email / mobile</p>
        <span></span>
      </div>

      <!-- LOGIN PANEL -->
      <section
        id="panel-login"
        class="auth-panel"
        role="tabpanel"
        aria-labelledby="tab-login"
      >
        <form class="auth-form" id="login-form">
          <label class="field">
            <span class="field-label">Email or mobile</span>
            <input
              id="login-identifier"
              type="text"
              autocomplete="username"
              required
              placeholder="you@example.com or 98765 43210"
            />
          </label>

          <label class="field">
            <span class="field-label">Password</span>
            <input
              id="login-password"
              type="password"
              autocomplete="current-password"
              required
              placeholder="Your password"
            />
          </label>

          <div
            class="field"
            style="
              flex-direction: row;
              justify-content: space-between;
              align-items: center;
              margin-top: 2px;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 0.78rem;
                color: var(--text-muted);
              "
            >
              <input type="checkbox" id="remember-me" style="margin: 0" />
              <span>Remember this device</span>
            </label>
            <button
              type="button"
              id="forgot-password"
              style="
                background: none;
                border: none;
                padding: 0;
                font-size: 0.78rem;
                color: var(--accent-mint);
                cursor: pointer;
              "
            >
              Forgot password?
            </button>
          </div>

          <button
            type="submit"
            class="btn-primary full btn-pulse"
            id="login-submit"
          >
            Log in
          </button>

          <p class="auth-hint center">
            Tip: Use the same email or mobile you registered with. Your data stays
            private and encrypted.
          </p>
        </form>
      </section>

      <!-- SIGNUP PANEL -->
      <section
        id="panel-signup"
        class="auth-panel hidden"
        role="tabpanel"
        aria-labelledby="tab-signup"
      >
        <form class="auth-form" id="signup-form">
          <div class="field-row">
            <label class="field">
              <span class="field-label">Full name</span>
              <input
                id="signup-name"
                type="text"
                autocomplete="name"
                required
                placeholder="Your full name"
              />
            </label>
          </div>

          <label class="field">
            <span class="field-label">Email address</span>
            <input
              id="signup-email"
              type="email"
              autocomplete="email"
              required
              placeholder="you@example.com"
            />
          </label>

          <label class="field">
            <span class="field-label">Mobile number</span>
            <div class="field-inline">
              <span class="dial-code">+91</span>
              <input
                id="signup-mobile"
                type="tel"
                inputmode="numeric"
                autocomplete="tel-national"
                required
                placeholder="98765 43210"
              />
            </div>
          </label>

          <label class="field">
            <span class="field-label">Create password</span>
            <input
              id="signup-password"
              type="password"
              autocomplete="new-password"
              required
              placeholder="Minimum 6 characters"
            />
          </label>

          <label class="field">
            <span class="field-label">Confirm password</span>
            <input
              id="signup-password2"
              type="password"
              autocomplete="new-password"
              required
              placeholder="Re-enter password"
            />
          </label>

          <div class="field-row">
            <label class="field">
              <span class="field-label">State</span>
              <input
                id="signup-state"
                type="text"
                placeholder="Maharashtra, Punjab, etc."
              />
            </label>
            <label class="field">
              <span class="field-label">District</span>
              <input id="signup-district" type="text" placeholder="Your district" />
            </label>
          </div>

          <label class="field">
            <span class="field-label">Farm size (approx.)</span>
            <input
              id="signup-farmSize"
              type="text"
              placeholder="e.g. 3 acres"
            />
          </label>

          <button
            type="submit"
            class="btn-primary full btn-pulse"
            id="signup-submit"
          >
            Create account
          </button>

          <p class="auth-hint center">
            Your account is protected using industry standard hashing and
            tokens. Use a strong password and keep it safe.
          </p>
        </form>
      </section>
    </section>
  </main>

  <!-- Bottom chatbar -->
  <div class="chatbar-shell">
    <form class="chatbar" id="login-chat-form">
      <div class="chatbar-inner">
        <span class="chatbar-icon">üå±</span>
        <input
          id="login-chat-input"
          type="text"
          autocomplete="off"
          placeholder="Ask what this platform can do for your farm..."
          aria-label="Ask the agriculture assistant"
        />
        <button
          type="submit"
          class="chatbar-send btn-pulse"
          aria-label="Send question"
        >
          ‚û§
        </button>
      </div>
      <p class="chatbar-hint">
        Example: ‚ÄúHow will this help with irrigation planning and mandi decisions?‚Äù
      </p>
    </form>
  </div>

  <!-- Modal for forgot password (still using simple flow for now) -->
  <div class="modal-backdrop" id="forgot-modal">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <p class="modal-title">Reset password (step 1)</p>
          <p class="modal-subtitle">
            In the next step you will connect this to email / SMS OTP from your backend.
          </p>
        </div>
        <button class="modal-close" type="button" id="forgot-close">√ó</button>
      </div>
      <form class="modal-form" id="forgot-form">
        <div class="modal-field">
          <label for="forgot-identifier" class="field-label"
            >Email or mobile</label
          >
          <input
            id="forgot-identifier"
            type="text"
            placeholder="you@example.com or 98765 43210"
          />
        </div>
        <button type="submit" class="modal-submit btn-pulse">
          Request reset (wire to OTP API later)
        </button>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = `http://${window.location.hostname}:4000`;

    // Tabs
    const tabLogin = document.getElementById('tab-login');
    const tabSignup = document.getElementById('tab-signup');
    const panelLogin = document.getElementById('panel-login');
    const panelSignup = document.getElementById('panel-signup');

    function showLogin() {
      tabLogin.classList.add('active');
      tabLogin.setAttribute('aria-selected', 'true');
      tabSignup.classList.remove('active');
      tabSignup.setAttribute('aria-selected', 'false');
      panelLogin.classList.remove('hidden');
      panelSignup.classList.add('hidden');
    }

    function showSignup() {
      tabSignup.classList.add('active');
      tabSignup.setAttribute('aria-selected', 'true');
      tabLogin.classList.remove('active');
      tabLogin.setAttribute('aria-selected', 'false');
      panelSignup.classList.remove('hidden');
      panelLogin.classList.add('hidden');
    }

    tabLogin.addEventListener('click', showLogin);
    tabSignup.addEventListener('click', showSignup);

    // LOGIN FORM
    const loginForm = document.getElementById('login-form');
    const loginIdentifier = document.getElementById('login-identifier');
    const loginPassword = document.getElementById('login-password');
    const loginSubmit = document.getElementById('login-submit');
    const rememberMe = document.getElementById('remember-me');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = loginIdentifier.value.trim();
      const password = loginPassword.value.trim();
      if (!id || !password) return;

      loginSubmit.classList.add('pressed');
      setTimeout(() => loginSubmit.classList.remove('pressed'), 250);

      const body = id.includes('@')
        ? { email: id, password }
        : { mobile: id, password };

      try {
        const res = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.message || 'Login failed. Check your details.');
          return;
        }

        const data = await res.json();
        const storage = rememberMe.checked ? localStorage : sessionStorage;
        storage.setItem('token', data.token);
        storage.setItem('userName', data.user?.name || 'Farmer');

        // Clean up token from the other storage
        if (rememberMe.checked) {
          sessionStorage.removeItem('token');
          sessionStorage.removeItem('userName');
        } else {
          localStorage.removeItem('token');
          localStorage.removeItem('userName');
        }

        window.location.href = 'index.html';
      } catch (err) {
        console.error(err);
        alert('Network error while logging in.');
      }
    });

    // SIGNUP FORM
    const signupForm = document.getElementById('signup-form');
    const signupName = document.getElementById('signup-name');
    const signupEmail = document.getElementById('signup-email');
    const signupMobile = document.getElementById('signup-mobile');
    const signupPassword = document.getElementById('signup-password');
    const signupPassword2 = document.getElementById('signup-password2');
    const signupState = document.getElementById('signup-state');
    const signupDistrict = document.getElementById('signup-district');
    const signupFarmSize = document.getElementById('signup-farmSize');
    const signupSubmit = document.getElementById('signup-submit');

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = signupName.value.trim();
      const email = signupEmail.value.trim();
      const mobile = signupMobile.value.trim();
      const password = signupPassword.value.trim();
      const password2 = signupPassword2.value.trim();

      if (!name || !email || !mobile || !password) {
        alert('Please fill all required fields.');
        return;
      }
      if (password.length < 6) {
        alert('Password should be at least 6 characters.');
        return;
      }
      if (password !== password2) {
        alert('Passwords do not match.');
        return;
      }

      signupSubmit.classList.add('pressed');
      setTimeout(() => signupSubmit.classList.remove('pressed'), 250);

      try {
        const res = await fetch(`${API_BASE}/api/auth/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            email,
            mobile,
            password,
            // extra fields can be stored later when you expand User.js
            state: signupState.value.trim(),
            district: signupDistrict.value.trim(),
            farmSize: signupFarmSize.value.trim(),
          }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.message || 'Signup failed.');
          return;
        }

        const data = await res.json();
        localStorage.setItem('token', data.token);
        localStorage.setItem('userName', data.user?.name || 'Farmer');
        window.location.href = 'index.html';
      } catch (err) {
        console.error(err);
        alert('Network error during signup.');
      }
    });

    // Social buttons ‚Äì front‚Äëend only for now
    const googleBtn = document.getElementById('google-login');
    const appleBtn = document.getElementById('apple-login');

    [googleBtn, appleBtn].forEach((btn) => {
      if (!btn) return;
      btn.addEventListener('click', () => {
        btn.classList.add('pressed');
        setTimeout(() => btn.classList.remove('pressed'), 250);
        alert(
          'Social login UI only right now. Connect this button to Google / Apple OAuth in your backend when ready.'
        );
      });
    });

    // Forgot password modal (ready to connect to your real OTP API later)
    const forgotBtn = document.getElementById('forgot-password');
    const forgotModal = document.getElementById('forgot-modal');
    const forgotClose = document.getElementById('forgot-close');
    const forgotForm = document.getElementById('forgot-form');

    if (forgotBtn && forgotModal && forgotClose && forgotForm) {
      forgotBtn.addEventListener('click', () => {
        forgotModal.classList.add('active');
      });
      forgotClose.addEventListener('click', () => {
        forgotModal.classList.remove('active');
      });
      forgotForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // Later: call /api/auth/forgot and start OTP flow
        alert(
          'Next step: wire this to your backend /api/auth/forgot endpoint to send email / SMS OTP.'
        );
        forgotModal.classList.remove('active');
      });
    }

    // Simple demo chat on login page
    const loginChatForm = document.getElementById('login-chat-form');
    const loginChatInput = document.getElementById('login-chat-input');

    if (loginChatForm && loginChatInput) {
      loginChatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const value = loginChatInput.value.trim();
        if (!value) return;
        alert('Demo assistant (login page) received: ' + value);
        loginChatInput.value = '';
      });
    }
  </script>
</body>
</html>
